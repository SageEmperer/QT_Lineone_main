{% extends 'base/base.html' %}
{% block title %}QTLineone | Faculty Mock Schedule{% endblock %}
{% block breadCrum %}

<!-- Breadcrumb -->
<div class="hk-pg-header d-flex justify-content-between mb-0" xmlns="http://www.w3.org/1999/html">
  <h4 class="hk-pg-title m-3">Slot Assigning </h4>
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb bg-transparent mb-0">
      <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
      <li class="breadcrumb-item active" aria-current="page">Slot Scheduling</li>
    </ol>
  </nav>
</div>
<!-- /Breadcrumb -->

{% endblock %}
{% block content %}
 <!-- message here -->

 {% if messages %}
 {% for message in messages %}
   {% if message.tags == "error" %}
     <div class="h-25 alert alert-danger alert-dismissible fade show mt-2 h-25 text-center" role="alert">{{ message }}</div>
   {% elif message.tags == "success" %}
     <div class="h-25 alert alert-success alert-dismissible fade show mt-2 h-25 text-center" role="alert">{{ message }}</div>
     {% else %}
    <div class="h-25 alert alert-info alert-dismissible fade show mt-2 h-25 text-center" role="alert">{{ message }}</div>
    {% endif %}
   {% endfor %}
 {% endif %}

<!-- Table starts here -->

<section class="hk-sec-wrapper shadow-lg p-3 mb-10 bg-white rounded">
 <div class="">
    <button  type="button" class="btn btn-primary mr-2 mb-3" data-toggle="modal" data-target="#Bookinterview">
      <i class="glyphicon glyphicon-plus"></i> Add Slot
    </button>
    <a href="{% url 'admin_slot_export' %}" class="btn btn-success mr-2 mb-3"><i class="glyphicon glyphicon-export"></i>
      Export</a>
    <button type="button" class="btn btn-secondary mr-2 mb-3" data-toggle="modal" data-target="#UploadSlot ">
      <i class="glyphicon glyphicon-import"></i> Import
    </button>
  </div>

  <div class="row">
    <div class="col-sm">
      <div class="table-wrap">
        <table id="datable_1" class="table table-hover w-100  pb-30 table-bordered">
          <thead class="bg-dark">
            <tr>
              <th class="text-white">S.no</th>
              <th class="text-white text-center">Faculty</th>
              <th class="text-white text-center">Course</th>
              <th class="text-white text-center">Specialization</th>
              <th class="text-white text-center">Available Slot</th>
                 <th class="text-white text-center">Mock Link</th>
              <th class="text-white text-center">Status</th>
              <th class="text-white text-center" >Action</th>
            </tr>
          </thead>
          <tbody>

            {% for assign in assigning %}
            <tr>
              <td>{{forloop.counter}}</td>
              <td class="text-center">{{assign.faculty.first_name}}&nbsp;{{assign.faculty.last_name}}</td>
              <td class="text-center">{{assign.course_name}}</td>
              <td class="text-center">{{assign.specialization_name}}</td>
              <td class="text-center">{{assign.available_slot}}</td>
              <td class="text-center">
                <button type="button" class="btn btn-link" data-toggle="tooltip" data-html="true" title="<em>Tooltip</em> <u>on</u> <b>Link</b>">
                  {{assign.mock_link}}
                  <button class="btn btn-icon btn-icon-only btn-icon-style-4 copyButton"><i class="fa fa-copy"></i></button>
                </button>
              </td>
              <td class="text-center">
                {% if assign.status == 'Active' %}
                  <span class="badge badge-success badge-pill mt-15 mr-10">Active</span>
                {% elif assign.status == 'Reschedule'  %}
                  <span class="badge badge-pumpkin badge-pill mt-15 mr-10">Reschedule</span>
                {% else %}
                  <span class="badge badge-danger badge-pill mt-15 mr-10">Cancel</span>
                {% endif %}
              </td>
              <td class="text-center">
                <div class="d-flex align-items-center justify-content-center">
                  <button class="btn btn-icon btn-success " data-toggle="modal" data-target="#Edit-{{assign.id}}">
                    <i class="fa fa-rocket"></i>
                  </button>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</section>
<!--    Table ends here -->

<!--    Book interview start here -->
<div class="modal fade" id="Bookinterview" tabindex="-1" role="dialog" aria-labelledby="Bookinterview" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header bg-dark">
        <h5 class="modal-title text-white">Add Slot</h5>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <form action="" method="post" class="Add_slot">
        {% csrf_token %}
        <div class="modal-body">
          <div class="mb-3">
            <label for="" class="form-label">Course<span class="text-danger"> *</span></label>
              <select class="form-control custom-select select2 course-select" name="course" id="course">
                      <option value="" disabled selected>Please Select</option>
                      {% for c in courses %}
                      <option value="{{c.id}}">{{c.course_name}}</option>
                       {% endfor %}
              </select>
          </div>
          <div class="mb-3">
            <label for="" class="form-label">Specialization <span class="text-danger">*</span></label>
            <select class="form-control custom-select select2 specialization-select" name="specialization" id="specialization">
              <option value="" disabled selected>Please Select</option>
              {% for specialization in specializations %}
                  <option value="{{ specialization.id }}">{{ specialization.specialization_name }}</option>
              {% endfor %}
          </select>
          </div>
          <div class="mb-3">
            <label for="" class="form-label">Faculty <span class="text-danger">*</span></label>
                <select class="form-control custom-select select2 faculty-select " name="faculty" id="faculty" >
                      <option value="" disabled selected >Please Select</option>
                      {% for f in faculties %}
                      <option value="{{f.id}}">{{f.first_name}} {{f.last_name}}</option>
                      {% endfor %}
                </select>
          </div>

          <div class="mb-3">
            <label for="" class="form-label">Available  Slot <span class="text-danger">*</span></label>
                       <input  class="form-control" type="datetime-local" id="datetime" name="datetime" >
          </div>
          <div class="mb-3">
              <label for="" class="form-label">Mock Link<span class="text-danger"> *</span></label>
                      <textarea  class="form-control"  name="link" ></textarea>
           </div>
        </div>
        <div class="modal-footer d-flex justify-content-center">
          <button type="submit" class="btn btn-primary">Submit</button>
          <button type="reset" class="btn btn-secondary">Reset</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!--    Book interview ends here -->



<!-- Edit model start here -->
{% for assign in assigning %}
<div class="modal fade" id="Edit-{{assign.id}}" tabindex="-1" role="dialog" aria-labelledby="Edit" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header bg-dark">
        <h5 class="modal-title text-white">Reschedule Slot</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true" class="text-white">&times;</span>
        </button>
      </div>
      <form action="{% url 'edit_admin_mock' assign.id %}" method="post" class="Edit_slot">
        {% csrf_token %}
        <div class="modal-body">
          <div class="container-fluid">
            <div class="row">
              <div class="col-sm">
                <div class="row mb-10">
                  <div class="col-md-6 mt-15">
                    <div class="custom-control custom-radio">
                      <input type="radio" name="type_of_change_{{assign.id}}" class="resc_check_re" value="Reschedule Slot" onclick="toggleFields('Edit-{{assign.id}}', this)">
                      <label for="" class="form-label">Reschedule </label>
                    </div>
                  </div>
                  <div class="col-md-6 mt-15">
                    <div class="custom-control custom-radio">
                      <input type="radio" name="type_of_change_{{assign.id}}" class="resc_check-can" value="Cancel Slot" onclick="toggleFields('Edit-{{assign.id}}', this)">
                      <label for="" class="form-label">Cancel </label> 
                    </div>
                  </div>
                  <div class="col-md-6 mt-15" id="radioError{{assign.id}}"></div>
                </div>
                <div class="mb-3" id="BookedFields-{{assign.id}}">
                  <label for="" class="form-label">Booked details</label>
                  <div class="form-group row">
                    <label for="" class="col-sm-4 col-form-label" >Student Name:</label>
                    <div class="col-sm-8">
                        <input type="text" class="form-control" value="{{ assign.student_name.first_name }} {{ assign.student_name.last_name }}" id="student"  readonly>
                    </div>
                  </div>
                  <div class="form-group row">
                    <label for="" class="col-sm-4 col-form-label" >Student ID:</label>
                    <div class="col-sm-8">
                        <input type="text" class="form-control" value=" {{ assign.student_name.token_id }}" id="student"   readonly>
                    </div>
                </div>
                </div>
                <div class="mb-3" id="rescheduleFields-{{assign.id}}">
                  <label for="" class="form-label">Available Slot <span class="text-danger">*</span></label>
                  <input type="datetime-local" class="form-control slot-input reschedule-input"  id="available_slot" name="available_slot">
                </div>
                <div class="mb-3" id="mockLinkField-{{assign.id}}">
                  <label for="" class="form-label">Mock Link<span class="text-danger"> *</span></label>
                  <input type="text" class="form-control slot-input reschedule-input" name="mock_link" placeholder="Enter mock link here." >
                </div>
                <div class="mb-3" id="rescheduleReason-{{assign.id}}">
                  <label for="" class="form-label">Reason for Reschedule Slot<span class="text-danger"> *</span></label>
                  <textarea class="form-control reschedule-reason reschedule-input" placeholder="What Would you like to say?" rows="5"  name="reschedule_reason" ></textarea>
                </div>
                <div class="mb-3" id="cancelFields-{{assign.id}}" style="display: none;">
                  <label for="">Reason for Cancel Slot <span class="text-danger">*</span></label>
                  <textarea class="form-control cancel-reason reschedule-input" placeholder="What Would you like to say?" rows="5" name="cancel_reason"></textarea>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer d-flex justify-content-center">
          <button type="submit" class="btn btn-primary" id="confirmAction">Confirm</button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endfor %}
<!-- Edit model end here -->


<!-- Upload model  -->


<div class="modal fade" id="UploadSlot" tabindex="-1" role="dialog" aria-labelledby="UploadSlot" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header bg-dark">
        <h5 class="modal-title text-white">Upload File</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true" class="text-whte">&times;</span>
        </button>
      </div>
      <form action="{% url 'admin_slot_import' %}" method="post" id="uploadfile" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="modal-body">
          <input type="file" name="admin_slot_file" accept=".csv" id="input-file-now" class="dropify" />
          <div id="csvPreview"></div>
         </div>
        <div class="modal-footer d-flex justify-content-center">
          <button type="submit" class="btn btn-primary">Submit</button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal" aria-label="Close">
            Close
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Upload model end here -->

{% endblock %}

{% block scripts %}
<!-- add faculty slots starts -->
<script>
  $(document).ready(function () {
    $(".course-select").change(function () {
      var course_id = $(this).val();
      var specialization = $(".specialization-select");
      specialization.empty().append('<option value="">Select Specialization</option>');
      if (course_id) {
        // Make AJAX request to fetch specializations based on the selected course
        $.getJSON('/spec_ajax/' + course_id, function (data) {
          // Check if the response contains the specialization_list key
          if (data.hasOwnProperty('specialization_list')) {
            $.each(data.specialization_list, function (index, spec) {
              specialization.append('<option value="' + spec.id + '">' + spec.name + '</option>');
            });
          } else {
            console.error('Error: specialization_list key not found in JSON response');
          }
        }).fail(function (jqxhr, testStatus, error) {
          console.error('Error', testStatus, error);
        });
      }
    });
  });
</script>
<script>
  $(document).ready(function () {
    $('.specialization-select').change(function(){
      var specialization_id= $(this).val();
      var faculty = $('.faculty-select');
      faculty.empty().append('<option value="">Select faculty</option>');
      if(specialization_id){
        $.getJSON('/faculty_ajax/'+ specialization_id, function (data){
          if(data.hasOwnProperty('faculty_list')){
            $.each(data.faculty_list,function(index,f){
              faculty.append('<option value="'+ f.id + '">' + f.first_name + ' '+ f.last_name + '</option>');
              });
            } else{
              console.error('Error: faculty_list key not found in JSON response');
            }
          }).fail(function(jqxhr,testStatus,error){
              console.error('Error',testStatus,error);
          });
        }
    });
  });
</script>
<script>
  // Validate form using jQuery Validation Plugin
  $(document).ready(function () {
    $.validator.addMethod("overspecialization", function (value, element) {
        return !/\d/.test(value);
    }, "Please enter a valid value.");

    $.validator.addMethod("radioRequired", function (value, element) {
        return $('input[name="type_of_change"]:checked').length > 0;
    }, "Please select an option.");

    $(".Add_slot").each(function () {
      $(this).validate({
        rules: {
        course:{
          required: true,
        },
        specialization:{
          required: true,

        },
        faculty:{
          required: true,
        },
        datetime: {
                required: true,
                overspecialization: false
            },
        link: {
                required: true,
                overspecialization: false
            },
        },
        messages: {
          course:{
            required: "Please Select Course."
          },
          specialization:{
            required: "Please Select Specialization."
          },
          faculty:{
            required: "Please Select Faculty."
          },
          datetime: {
                required: "Please Select Slot."
            },
            link: {
                required: "Please provide link."
            },
        },
        submitHandler: function (form) {
            form.submit();
        },
    });
  });
});
</script>
<!-- add faculty slots ends -->

<!-- edit faculty slots starts -->
<script>
  // Validate form using jQuery Validation Plugin
  $(document).ready(function () {
    $.validator.addMethod("overspecialization", function (value, element) {
        return !/\d/.test(value);
    }, "Please enter a valid value.");

    $.validator.addMethod("radioRequired", function (value, element) {
        return $('input[name="type_of_change"]:checked').length > 0;
    }, "Please select an option.");

    $(".Edit_slot").each(function () {

      $(this).validate({
        rules: {
          available_slot: {
                required: true,
                overspecialization: false
            },
          mock_link: {
                required: true,
                overspecialization: false
            },
            reschedule_reason: {
                required:true,
            },
            cancel_reason: {
                required:true,
            },
            type_of_change: {
                radioRequired: true
            }

        },
        messages: {
          available_slot: {
                required: "Please Select Slot."
            },
            mock_link: {
                required: "Please provide link."
            },
            reschedule_reason:
            {
              required: "Please enter a reason.",
            },
            cancel_reason: {
                required:" Please enter a reason",
            },
            type_of_change: {
                radioRequired: "Please select an option."
            }

        },
        errorPlacement: function(error, element) {
            if (element.attr("name") == "type_of_change") {
                error.appendTo("#radioError");
            } else {
                error.insertAfter(element);
            }
        },
        submitHandler: function (form) {
            form.submit();
        },
    });
  });
});
</script>
<!-- edit faculty slots ends -->

<!-- reschedule and cancel radiobuttons starts -->
<script>
  function toggleFields(modalId, radio) {
    var rescheduleFields = document.getElementById('rescheduleFields-' + modalId.split('-')[1]);
    var cancelFields = document.getElementById('cancelFields-' + modalId.split('-')[1]);
    var mockLinkField = document.getElementById('mockLinkField-' + modalId.split('-')[1]);
    var rescheduleReason = document.getElementById('rescheduleReason-' + modalId.split('-')[1]);
    
    if (radio.value === 'Reschedule Slot') {
      rescheduleReason.style.display = 'block';
      rescheduleFields.style.display = 'block';
      cancelFields.style.display = 'none';
      mockLinkField.style.display = 'block';  // Show mock link field for reschedule
    } else if (radio.value === 'Cancel Slot') {
      rescheduleReason.style.display = 'none';
      rescheduleFields.style.display = 'none';
      cancelFields.style.display = 'block';
      mockLinkField.style.display = 'none';  // Hide mock link field for cancel
    }
  }
  
  // Initialize fields display on page load
  document.addEventListener("DOMContentLoaded", function() {
    var radioButtons = document.querySelectorAll('input[class^="resc_check"]');
    for (var i = 0; i < radioButtons.length; i++) {
      if (radioButtons[i].checked) {
        var modalId = radioButtons[i].closest('.modal').id;
        toggleFields(modalId, radioButtons[i]);
      }
    }
  });
</script>

  <!-- reschedule and cancel radiobuttons ends -->

<!-- upload file starts  -->
<script>
  function validateUploadForm(form) {
    $(form).find('#input-file-now').on('change', function () {
      var file = this.files[0];
      var fileExt = file.name.split('.').pop().toLowerCase();

      if (fileExt === 'csv') {
        $(form).find('button[type="submit"]').prop('disabled', false);
        $(form).find('#input-file-now').html('');
      } else {
        $(form).find('button[type="submit"]').prop('disabled', true);
        $(form).find('#csvPreview').html('<span style="color: red;">Only CSV files are allowed.</span>');
      }
    });

    $(form).on('submit', function (e) {
      var file = $(form).find('#input-file-now')[0].files[0];

      if (!file) {
        e.preventDefault();
        $(form).find('#csvPreview').html('<span style="color: red;">Please select a csv file.</span>');
      }
    });
  }

  $('#UploadSlot').on('shown.bs.modal', function () {
    validateUploadForm($(this).find('form'));
  });
</script>
<!-- uppload file ends -->

<!-- for fading previous dates -->
<script>
    $(document).ready(function () {
      var now = new Date().toISOString().slice(0, 16);

      $("#datetime").attr("min", now);
      $("#available_slot").attr("min", now);
  
     
    })
</script>
  


<script>
  $(document).ready(function() {
    $('.copyButton').click(function() {
      var mockLink = $(this).parent().text().trim(); // Get the text content of the parent element
      var tempInput = document.createElement('input');
      tempInput.setAttribute('type', 'text');
      tempInput.value = mockLink;
      document.body.appendChild(tempInput);
      tempInput.select();
      document.execCommand('copy');
      document.body.removeChild(tempInput);
    });
  });
</script>

{% endblock %}